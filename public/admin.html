<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrador - VotaciÃ³n Escolar</title>
<style>
body { font-family: Arial, sans-serif; background:#f1f5f9; margin:0 }
.container { max-width:1200px; margin:auto; padding:20px }
.hidden { display:none }
button { padding:8px 14px; margin:5px; cursor:pointer }
table { width:100%; border-collapse:collapse; margin-top:10px }
th,td { border:1px solid #ccc; padding:6px; text-align:left }
th { background:#e5e7eb }
header { background:white; padding:15px; border-radius:8px; margin-bottom:20px }
.card { background:white; padding:15px; border-radius:8px; margin-bottom:20px }
.danger { background:#ef4444; color:white }
.success { background:#10b981; color:white }
.warning { background:#f59e0b; color:white }
</style>
</head>

<body>
<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="card">
<h2>ğŸ” Acceso Administrador</h2>
<input id="adminCode" type="password" placeholder="Clave administrador">
<br><br>
<button onclick="login()">Ingresar</button>
<p id="loginError" style="color:red"></p>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">

<header>
<h1>âš™ï¸ Panel de AdministraciÃ³n</h1>
<p id="estadoVotacion">Estado: â€”</p>
<button onclick="abrirCerrar()" class="warning">Abrir / Cerrar votaciÃ³n</button>
<button onclick="resetearVotacion()" class="danger">â™»ï¸ RESETEAR VOTACIÃ“N</button>
</header>

<div class="card">
<h2>ğŸ“‹ Estudiantes</h2>
<button onclick="cargarEstudiantes()">ğŸ”„ Actualizar</button>
<button onclick="eliminarTodos()" class="danger">ğŸ—‘ï¸ ELIMINAR TODOS</button>
<button onclick="imprimirCarnets()" class="success">ğŸ–¨ï¸ IMPRIMIR CARNETS</button>
<div id="tablaEstudiantes"></div>
</div>

<div class="card">
<h2>ğŸ“¥ Importar estudiantes (Excel ya procesado)</h2>
<input type="file" id="file" accept=".json">
<p>Sube un JSON previamente generado</p>
<button onclick="importar()">Importar</button>
</div>

</div>
</div>

<script>
const API = "/api";
let ADMIN = "";

function login(){
  ADMIN = document.getElementById("adminCode").value;
  fetch(API+"/admin/login",{method:"POST",headers:{"x-admin-code":ADMIN}})
  .then(r=>r.ok?r.json():Promise.reject())
  .then(()=>{
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    cargarEstado();
    cargarEstudiantes();
  })
  .catch(()=>document.getElementById("loginError").innerText="CÃ³digo incorrecto");
}

function cargarEstado(){
 fetch(API+"/check-status")
 .then(r=>r.json())
 .then(d=>{
  document.getElementById("estadoVotacion").innerText =
   "Estado: "+(d.open?"ABIERTA":"CERRADA");
 });
}

function abrirCerrar(){
 fetch(API+"/admin/election",{
  method:"POST",
  headers:{"Content-Type":"application/json","x-admin-code":ADMIN},
  body:JSON.stringify({action:"open"})
 }).then(()=>cargarEstado());
}

function resetearVotacion(){
 if(!confirm("âš ï¸ Esto borra votos y reinicia todo. Â¿Continuar?")) return;
 fetch(API+"/admin/reset-election",{
  method:"POST",
  headers:{"x-admin-code":ADMIN}
 }).then(()=>{
  alert("VotaciÃ³n reiniciada");
  cargarEstado();
  cargarEstudiantes();
 });
}

function cargarEstudiantes(){
 fetch(API+"/admin/students",{headers:{"x-admin-code":ADMIN}})
 .then(r=>r.json())
 .then(d=>{
  let html="<table><tr><th>CÃ³digo</th><th>Nombre</th><th>Grado</th><th>Curso</th></tr>";
  d.students.forEach(s=>{
    html+=`<tr>
      <td>${s.access_code}</td>
      <td>${s.full_name}</td>
      <td>${s.grade}</td>
      <td>${s.course}</td>
    </tr>`;
  });
  html+="</table>";
  document.getElementById("tablaEstudiantes").innerHTML=html;
 });
}

function eliminarTodos(){
 if(!confirm("âš ï¸ ELIMINAR TODOS LOS ESTUDIANTES. Â¿Seguro?")) return;
 fetch(API+"/admin/clear-students",{method:"POST",headers:{"x-admin-code":ADMIN}})
 .then(()=>{alert("Estudiantes eliminados"); cargarEstudiantes();});
}

function importar(){
 const f=document.getElementById("file").files[0];
 if(!f) return alert("Selecciona archivo");
 const r=new FileReader();
 r.onload=e=>{
  const students=JSON.parse(e.target.result);
  fetch(API+"/admin/import",{
   method:"POST",
   headers:{"Content-Type":"application/json","x-admin-code":ADMIN},
   body:JSON.stringify({students})
  }).then(()=>{alert("Importados"); cargarEstudiantes();});
 };
 r.readAsText(f);
}

function imprimirCarnets(){
 const win=window.open("");
 win.document.write("<h1>Carnets Electorales</h1>");
 document.querySelectorAll("#tablaEstudiantes tr").forEach((tr,i)=>{
  if(i===0)return;
  win.document.write("<div style='border:1px solid #000;padding:10px;margin:10px'>"+tr.innerHTML+"</div>");
 });
 win.print();
}
</script>

</body>
</html>
